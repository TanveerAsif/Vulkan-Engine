name: Vulkan-Engine (Bazel)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    # Using Ubuntu 22.04 for CI
    # Vulkan SDK 1.4.304.1 supports jammy repository
    runs-on: ubuntu-22.04


    steps:
    - uses: actions/checkout@v4

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: ~/.cache/bazel
        key: bazel-${{ runner.os }}-${{ github.ref_name }}
        restore-keys: |
          bazel-${{ runner.os }}-

    - name: Install Vulkan SDK with shaderc
      run: |
        UBUNTU_CODENAME=$(lsb_release -cs)
        echo "Detected Ubuntu: $UBUNTU_CODENAME"
        
        # For Ubuntu 24.04+ use native packages (LunarG repo not available yet)
        # For older versions, try LunarG repository first
        if [[ "$UBUNTU_CODENAME" == "noble" ]]; then
          echo "Using Ubuntu native Vulkan packages for Ubuntu 24.04"
          sudo apt-get update
          sudo apt-get install -y \
            libvulkan-dev \
            vulkan-validationlayers-dev \
            spirv-tools \
            libshaderc-dev \
            vulkan-tools
        else
          # Download and install Vulkan SDK from LunarG for older Ubuntu versions
          wget -qO /tmp/lunarg-signing-key-pub.asc https://packages.lunarg.com/lunarg-signing-key-pub.asc
          sudo mkdir -p /etc/apt/keyrings
          sudo cat /tmp/lunarg-signing-key-pub.asc | sudo gpg --dearmor -o /etc/apt/keyrings/lunarg-archive-keyring.gpg

          # Add LunarG repository - Latest Vulkan SDK
          echo "deb [signed-by=/etc/apt/keyrings/lunarg-archive-keyring.gpg] https://packages.lunarg.com/vulkan $UBUNTU_CODENAME main" | sudo tee /etc/apt/sources.list.d/lunarg-vulkan.list

          sudo apt-get update
          sudo apt-get install -y vulkan-sdk || {
            echo "Vulkan SDK installation failed, trying alternative method..."
            sudo apt-get install -y \
              libvulkan-dev \
              vulkan-validationlayers \
              spirv-tools \
              libshaderc-dev || {
              echo "Alternative installation also failed, building minimal setup..."
              sudo apt-get install -y libvulkan-dev vulkan-tools
            }
          }
        fi

    - name: Install additional dependencies
      run: |
        sudo apt-get install -y libglfw3-dev

    - name: Set Vulkan SDK environment
      run: |
        # Vulkan SDK installs to /usr with the package
        VULKAN_SDK_PATH="/usr"
        echo "VULKAN_SDK=$VULKAN_SDK_PATH" >> $GITHUB_ENV

        # Detect library path dynamically
        if [ -d "/usr/lib/x86_64-linux-gnu" ]; then
          LIB_PATH="/usr/lib/x86_64-linux-gnu"
        else
          LIB_PATH="/usr/lib"
        fi

        # Generate .bazelrc.user for CI
        cat > .bazelrc.user << EOF
        # CI-generated Bazel configuration
        build --linkopt=-L$LIB_PATH
        build --linkopt=-Wl,-rpath,$LIB_PATH
        EOF

        # Verify shaderc is available (either library or headers)
        if ldconfig -p | grep -q libshaderc || [ -f /usr/include/shaderc/shaderc.h ]; then
          echo "âœ“ shaderc found"
        else
          echo "WARNING: shaderc not found, build may fail"
        fi

    - name: Install Bazelisk (no cache)
      run: |
        curl -L https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64 -o bazel
        chmod +x bazel
        sudo mv bazel /usr/local/bin/bazel

    - name: Bazel version
      run: bazel version

    - name: Bazel build
      run: bazel build --compilation_mode=dbg //...

